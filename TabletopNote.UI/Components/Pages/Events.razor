@page "/campaigns/{campaignId:int}/events"
@using TabletopNote.Shared
@using TabletopNote.UI.Clients
@using TabletopNote.UI.Mappings
@using TabletopNote.UI.ViewModels
@inject DocumentsApiClient DocumentsApi
@inject NavigationManager NavigationManager

<PageTitle>Events</PageTitle>

<MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
    <MudText Typo="Typo.h4" Color="Color.Success">
        Events of Note
    </MudText>

    <MudButton Variant="Variant.Filled"
               Color="Color.Success"
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="AddEvent">
        New Event
    </MudButton>
</MudStack>

@if (State.Page is null)
{
    <p>Loading…</p>
}
else
{
    <MudPaper Elevation="3" Class="pa-6 mt-4">
        <MudTimeline Reverse="false">
            @foreach (var ev in State.Page.CalendarEvents.OrderBy(e => e.EventStartDate))
            {
                <MudTimelineItem Color="Color.Primary"
                                 Icon="@Icons.Material.Filled.Event">

                    <ChildContent>
                        <MudPaper Class="pa-3 timeline-card"
                                  Elevation="0"
                                  Outlined="true">

                            <MudStack Direction="Row"
                                      AlignItems="AlignItems.Center"
                                      Spacing="1">

                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule"
                                             Size="Size.Small"
                                             Class="me-1" />
                                    @FormatEventDate(ev)
                                </MudText>

                                @if (ev.EventEndDate.Date != ev.EventStartDate.Date)
                                {
                                    <MudChip T="string"
                                             Size="Size.Small"
                                             Color="Color.Info"
                                             Variant="Variant.Outlined">
                                        Multi-day
                                    </MudChip>
                                }
                            </MudStack>

                            <MudText Typo="Typo.subtitle1">
                                @ev.EventName
                            </MudText>

                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @ev.EventDescription
                            </MudText>

                            <MudStack Direction="Row"
                                      Justify="Justify.FlexStart"
                                      Class="mt-2">
                                <MudButton Variant="Variant.Text"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Edit"
                                           OnClick="() => UpdateSelectedEvent(ev)">
                                    View / Edit
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    </ChildContent>
                </MudTimelineItem>
            }
        </MudTimeline>
    </MudPaper>
}

@code {
    [Parameter]
    public int CampaignId { get; set; }

    private readonly EventPageState State = new();

    protected override async Task OnInitializedAsync()
    {
        var dto = await DocumentsApi.GetAllCalendarEvents(CampaignId);

        State.Page = new EventsByCampaignVM
        {
            CampaignId = dto.CampaignId,
            CampaignName = dto.CampaignName,
            CalendarEvents = dto.CalendarEvents.Select(e => e.ToViewModel()).ToList()
        };
    }

    private void AddEvent()
    {

    }

    private void UpdateSelectedEvent(CalendarEventVM ev)
    {
        NavigationManager.NavigateTo($"/campaigns/{CampaignId}/events/{ev.CalendarEventId}");
    }

    private string FormatEventDate(CalendarEventVM ev)
    {
        if (ev.EventEndDate.Date == ev.EventStartDate.Date)
        {
            return ev.EventStartDate.ToString("MMM dd, yyyy");
        }

        return $"{ev.EventStartDate:MMM dd} – {ev.EventEndDate:MMM dd, yyyy}";
    }
}
