@page "/campaigns/{campaignId:int}/events"
@using TabletopNote.Shared
@using TabletopNote.UI.Clients
@using TabletopNote.UI.Mappings
@using TabletopNote.UI.ViewModels
@inject DocumentsApiClient DocumentsApi
@inject NavigationManager NavigationManager

<PageTitle>Events</PageTitle>

<MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
    <MudText Typo="Typo.h4" Color="Color.Success">
        Events of Note
    </MudText>

    <MudButton Variant="Variant.Outlined"
               Color="Color.Warning"
               StartIcon="@Icons.Material.Outlined.ArrowBack"
               OnClick="NavigateBack">
        Campaign Info
    </MudButton>

    <MudButton Variant="Variant.Filled"
               Color="Color.Success"
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="AddEvent">
        New Event
    </MudButton>
</MudStack>

@if (State.Page is null)
{
    <p>Loading…</p>
}
else
{
    <MudPaper Elevation="3" Class="pa-6 mt-4">
        <MudTimeline 
            Reverse="false"
            Class="centered-timeline">
            @foreach (var campaignEvent in State.Page.CalendarEvents.OrderBy(e => e.EventStartDate))
            {
                <MudTimelineItem Color="Color.Primary"
                                 Icon="@Icons.Material.Filled.Event">

                    <ChildContent>
                        <MudPaper Class="pa-3 timeline-card"
                                  Elevation="0"
                                  Outlined="true">

                            <MudStack Direction="Row"
                                      AlignItems="AlignItems.Center"
                                      Spacing="1">

                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule"
                                             Size="Size.Small"
                                             Class="me-1" />
                                    @FormatEventDate(campaignEvent)
                                </MudText>

                                @if (campaignEvent.EventEndDate!.Value != campaignEvent.EventStartDate!.Value)
                                {
                                    <MudChip T="string"
                                             Size="Size.Small"
                                             Color="Color.Info"
                                             Variant="Variant.Outlined">
                                        Multi-day
                                    </MudChip>
                                }
                            </MudStack>

                            <MudText Typo="Typo.subtitle1">
                                @campaignEvent.EventName
                            </MudText>

                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @campaignEvent.EventDescription
                            </MudText>

                            <MudStack Direction="Row"
                                      Justify="Justify.Center"
                                      Class="mt-2">
                                <MudButton Variant="Variant.Text"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Edit"
                                           OnClick="() => UpdateSelectedEvent(campaignEvent.CalendarEventId)">
                                    View / Edit
                                </MudButton>
                                <MudButton Variant="Variant.Text"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           StartIcon="@Icons.Material.Filled.Delete"
                                           OnClick="() => DeleteCalendarEvent(CampaignId, campaignEvent.CalendarEventId)">
                                    Delete
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    </ChildContent>
                </MudTimelineItem>
            }
        </MudTimeline>
    </MudPaper>
}

@code {
    [Parameter]
    public int CampaignId { get; set; }

    private readonly EventPageState State = new();

    protected override async Task OnInitializedAsync()
    {
        var dto = await DocumentsApi.GetAllCalendarEvents(CampaignId);

        State.Page = new EventsByCampaignVM
        {
            CampaignId = dto.CampaignId,
            CampaignName = dto.CampaignName,
            CalendarEvents = dto.CalendarEvents.Select(e => e.ToViewModel()).ToList()
        };
    }

    private void AddEvent()
    {
        NavigationManager.NavigateTo($"campaigns/{CampaignId}/events/new");
    }

    private void UpdateSelectedEvent(int calendarEventId)
    {
        NavigationManager.NavigateTo($"campaigns/{CampaignId}/events/{calendarEventId}");
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"/campaigns/{CampaignId}");
    }

    private string FormatEventDate(CalendarEventVM ev)
    {
        if (ev.EventStartDate is not DateTime start ||
            ev.EventEndDate is not DateTime end)
            return string.Empty;

        if (start.Date == end.Date)
            return start.ToString("MMM dd, yyyy");

        return $"{start:MMM dd} – {end:MMM dd, yyyy}";
    }

    async Task DeleteCalendarEvent(int campaignId, int calendarEventId)
    {
        await DocumentsApi.DeleteCalendarEvent(campaignId, calendarEventId);

        var eventToRemove = State.Page?.CalendarEvents
            .FirstOrDefault(r => r.CalendarEventId == calendarEventId && r.CampaignId == campaignId);

        if (eventToRemove != null)
        {
            State.Page?.CalendarEvents.Remove(eventToRemove);
        }

        StateHasChanged();
    }

}
