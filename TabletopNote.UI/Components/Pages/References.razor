@page "/campaigns/{campaignId:int}/references"

@using TabletopNote.Shared
@using TabletopNote.UI.Clients
@using TabletopNote.UI.Mappings
@using TabletopNote.UI.ViewModels
@using MudBlazor
@inject DocumentsApiClient DocumentsApi
@inject NavigationManager NavigationManager

<PageTitle>References</PageTitle>

<MudStack Spacing="4">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
        <MudText Typo="Typo.h4" Color="Color.Info">
            Attachments &amp; References
        </MudText>

        <MudText Typo="Typo.body1" Color="Color.Info">
            Local files and URL links related to the campaign. Attach new files here, or click on existing references for more information.
        </MudText>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Warning"
                   StartIcon="@Icons.Material.Outlined.ArrowBack"
                   OnClick="NavigateBack">
            Campaign Info
        </MudButton>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.AttachFile"
                   OnClick="AddReference">
            New Reference
        </MudButton>
    </MudStack>

    @if (State.Page is null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Info" />
    }
    else
    {
        <MudGrid Spacing="2">
            @foreach (var reference in State.Page.ReferenceDocuments)
            {
                <MudItem xs="12" sm="6" md="4" lg="4" xl="4">
                    <MudStack AlignItems="AlignItems.Center">

                        <MudPaper Outlined="true"
                                  Class="pa-4 mx-auto reference-outline"
                                  Style="height:100%; max-width:420px; background-color:#1E1E1E; border-radius:12px; border-color:rgb(50,153,255)">

                            <MudStack Spacing="2"
                                      AlignItems="AlignItems.Center"
                                      Style="text-align:center; min-width:220px;">

                                <MudStack Direction="Row"
                                          AlignItems="AlignItems.Center"
                                          Spacing="1"
                                          JustifyContent="Center">
                                    <MudIcon Icon="@GetReferenceIcon(reference)"
                                             Color="Color.Info"
                                             Size="Size.Medium" />
                                    <MudText Typo="Typo.subtitle1">
                                        @reference.ReferenceFileName
                                    </MudText>
                                </MudStack>

                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @reference.FileDescription
                                </MudText>

                                @if (!string.IsNullOrWhiteSpace(reference.Url))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                        <MudIcon Icon="@Icons.Material.Filled.Link"
                                                 Size="Size.Small"
                                                 Class="me-1" />
                                        External Link
                                    </MudText>
                                }
                                else if (!string.IsNullOrWhiteSpace(reference.FilePath))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                        <MudIcon Icon="@Icons.Material.Filled.AttachFile"
                                                 Size="Size.Small"
                                                 Class="me-1" />
                                        @reference.FilePath
                                    </MudText>
                                }

                                <MudDivider Class="my-2" />

                                <MudStack Direction="Row" Width="100%">
                                    <MudButton FullWidth="true"
                                               StartIcon="@Icons.Material.Filled.Edit"
                                               Color="Color.Info"
                                               Variant="Variant.Text"
                                               OnClick="() => UpdateSelectedReference(reference.FileId)">
                                        Edit
                                    </MudButton>

                                    <MudDivider Vertical="true" FlexItem="true" />

                                    <MudButton FullWidth="true"
                                               StartIcon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               Variant="Variant.Text"
                                               OnClick="() => DeleteCampaignReference(CampaignId, reference.FileId)">
                                        Delete
                                    </MudButton>
                                </MudStack>

                               @*  <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.OpenInNew"
                                           OnClick="@(() => UpdateSelectedReference(reference.FileId))"
                                           >
                                </MudButton>

                                <MudCardActions Class="justify-end">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   StopPropagation="true"
                                                   OnClick="() => DeleteCampaignReference(CampaignId, reference.FileId)" />
                                </MudCardActions> *@

                            </MudStack>
                        </MudPaper>

                    </MudStack>
                </MudItem>

            }
        </MudGrid>
    }
</MudStack>


@code {
    [Parameter]
    public int CampaignId { get; set; }

    private readonly ReferencePageState State = new();

    protected override async Task OnInitializedAsync()
    {
        var dto = await DocumentsApi.GetAllReferenceDocuments(CampaignId);

        State.Page = new ReferencesByCampaignVM
        {
            CampaignId = dto.CampaignId,
            CampaignName = dto.CampaignName,
            ReferenceDocuments = dto.ReferenceDocuments.Select(rd => rd.ToViewModel()).ToList()
        };
    }

    private void AddReference()
    {
        NavigationManager.NavigateTo($"campaigns/{CampaignId}/references/new");
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"/campaigns/{CampaignId}");
    }

    private void UpdateSelectedReference(int fileId)
    {
        NavigationManager.NavigateTo($"/campaigns/{CampaignId}/references/{fileId}");
    }

    async Task DeleteCampaignReference(int campaignId, int fileId)
    {
        await DocumentsApi.DeleteReferenceDocument(campaignId, fileId);

        var referenceToRemove = State.Page?.ReferenceDocuments
            .FirstOrDefault(r => r.FileId == fileId && r.CampaignId == campaignId);

        if (referenceToRemove != null)
        {
            State.Page?.ReferenceDocuments.Remove(referenceToRemove);
        }

        StateHasChanged();
    }

    private string GetReferenceIcon(ReferenceDocumentVM reference)
    {
        if (!string.IsNullOrWhiteSpace(reference.Url))
            return Icons.Material.Filled.Link;

        if (!string.IsNullOrWhiteSpace(reference.FilePath))
            return Icons.Material.Filled.AttachFile;

        return Icons.Material.Filled.InsertDriveFile;
    }

}
