@page "/campaigns/{campaignId:int}/references"
@using TabletopNote.Shared
@using TabletopNote.UI.Clients
@using TabletopNote.UI.Mappings
@using TabletopNote.UI.ViewModels
@using MudBlazor
@inject DocumentsApiClient DocumentsApi
@inject NavigationManager NavigationManager

<PageTitle>References</PageTitle>

<MudStack Spacing="4">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
        <MudText Typo="Typo.h4" Color="Color.Info">
            Attachments &amp; References
        </MudText>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Warning"
                   StartIcon="@Icons.Material.Outlined.ArrowBack"
                   OnClick="NavigateBack">
            Campaign Info
        </MudButton>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.AttachFile"
                   OnClick="AddDocument">
            New Reference
        </MudButton>
    </MudStack>

    @if (State.Page is null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Info" />
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var reference in State.Page.ReferenceDocuments)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudStack AlignItems="AlignItems.Center">

                        <MudPaper Outlined="true"
                                  Class="pa-4"
                                  Style="border-radius:12px; display:inline-block;">

                            <MudStack Spacing="2"
                                      AlignItems="AlignItems.Center"
                                      Style="text-align:center; min-width:220px;">

                                <MudStack Direction="Row"
                                          AlignItems="AlignItems.Center"
                                          Spacing="1"
                                          JustifyContent="Center">
                                    <MudIcon Icon="@GetReferenceIcon(reference)"
                                             Color="Color.Info"
                                             Size="Size.Medium" />
                                    <MudText Typo="Typo.subtitle1">
                                        @reference.ReferenceFileName
                                    </MudText>
                                </MudStack>

                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @reference.FileDescription
                                </MudText>

                                @if (!string.IsNullOrWhiteSpace(reference.Url))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                        <MudIcon Icon="@Icons.Material.Filled.Link"
                                                 Size="Size.Small"
                                                 Class="me-1" />
                                        External Link
                                    </MudText>
                                }
                                else if (!string.IsNullOrWhiteSpace(reference.FilePath))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                        <MudIcon Icon="@Icons.Material.Filled.AttachFile"
                                                 Size="Size.Small"
                                                 Class="me-1" />
                                        Uploaded File
                                    </MudText>
                                }

                                <MudDivider Class="my-2" />

                                <MudButton Variant="Variant.Text"
                                           Color="Color.Info"
                                           StartIcon="@Icons.Material.Filled.Edit">
                                    Update Reference
                                </MudButton>

                            </MudStack>
                        </MudPaper>

                    </MudStack>
                </MudItem>

            }
        </MudGrid>
    }
</MudStack>


@code {
    [Parameter]
    public int CampaignId { get; set; }

    private readonly ReferencePageState State = new();

    protected override async Task OnInitializedAsync()
    {
        var dto = await DocumentsApi.GetAllReferenceDocuments(CampaignId);

        State.Page = new ReferencesByCampaignVM
        {
            CampaignId = dto.CampaignId,
            CampaignName = dto.CampaignName,
            ReferenceDocuments = dto.ReferenceDocuments.Select(rd => rd.ToViewModel()).ToList()
        };
    }

    private void AddDocument()
    {

    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"/campaigns/{CampaignId}");
    }

    private void UpdateSelectedReference(int fileId)
    {
        NavigationManager.NavigateTo($"/references/{fileId}/edit");
    }

    private string GetReferenceIcon(ReferenceDocumentVM reference)
    {
        if (!string.IsNullOrWhiteSpace(reference.Url))
            return Icons.Material.Filled.Link;

        if (!string.IsNullOrWhiteSpace(reference.FilePath))
            return Icons.Material.Filled.AttachFile;

        return Icons.Material.Filled.InsertDriveFile;
    }

}
