@page "/campaigns/{CampaignId:int}"
@page "/campaigns/new"
@using TabletopNote.Shared.Dto;
@using TabletopNote.UI.Clients
@using TabletopNote.UI.ViewModels
@using TabletopNote.Shared
@inject DocumentsApiClient DocumentsApi
@inject NavigationManager NavigationManager

<!-- Side Panel -->
@if (!IsNewCampaign)
{
    <MudDrawer Open="true" Elevation="1" Width="260px" ClipMode="DrawerClipMode.Never">
        <MudNavMenu Dense="true" Class="pa-2">
            <CampaignSectionNav CampaignId="@CampaignId" IsHorizontal="false" ButtonSize="Size.Medium" IconSize="Size.Medium" />
        </MudNavMenu>
    </MudDrawer>
}

<MudMainContent Class="pa-6">
    @if (Campaign == null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudPaper Elevation="4" Class="pa-6 mx-auto"
                  Style="max-width:800px; border-radius:12px; background-color:#1E1E1E;">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h3" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Class="me-2" />
                    @(IsNewCampaign ? "New Campaign" : Campaign.CampaignName)
                </MudText>

                <MudForm @ref="_form" Model="Campaign">
                    <MudTextField Label="Campaign Name"
                                  For="@(() => Campaign.CampaignName)"
                                  Required="true"
                                  MaxLength="100"
                                  @bind-Value="Campaign.CampaignName"
                                  Variant="Variant.Outlined" />

                    <MudTextField Label="Description"
                                  For="@(() => Campaign.CampaignDescription)"
                                  Required="false"
                                  MaxLength="2000"
                                  @bind-Value="Campaign.CampaignDescription"
                                  Variant="Variant.Outlined"
                                  Lines="4" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveCampaign">
                    </MudButton>

                    <!-- Quick Nav Buttons for small screens -->
                    <MudHidden Breakpoint="Breakpoint.MdAndUp">
                        <CampaignSectionNav CampaignId="@CampaignId" IsHorizontal="true" ButtonSize="Size.Small" IconSize="Size.Small" />
                    </MudHidden>
                </MudForm>
            </MudStack>
        </MudPaper>
    }
</MudMainContent>

@code {
    private MudForm _form = null!;
    private bool IsNewCampaign => CampaignId == 0;

    [Parameter]
    public int CampaignId { get; set; }

    CampaignVM Campaign { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (IsNewCampaign)
        {
            Campaign = new CampaignVM
            {
                CampaignName = string.Empty
            };
        }
        else
        {
            var campaignDto = await DocumentsApi.GetCampaignById(CampaignId);

            Campaign = new CampaignVM
            {
                CampaignId = campaignDto.CampaignId,
                CampaignName = campaignDto.CampaignName,
                CampaignDescription = string.IsNullOrWhiteSpace(campaignDto.CampaignDescription) ? null : campaignDto.CampaignDescription,
                CampaignDocuments = campaignDto.CampaignDocuments.ToList(),
                ReferenceDocuments = campaignDto.ReferenceDocuments.ToList(),
                CalendarEvents = campaignDto.CalendarEvents.ToList()
            };
        }
    }

    public async Task SaveCampaign()
    {
        if (IsNewCampaign)
        {
            var campaignToAdd = new CampaignAddDto
            {
                CampaignName = Campaign.CampaignName,
                CampaignDescription = string.IsNullOrWhiteSpace(Campaign.CampaignDescription) ? null : Campaign.CampaignDescription
            };

            await DocumentsApi.AddCampaign(campaignToAdd);

            NavigationManager.NavigateTo($"/");
        }
        else
        {
            var campaignToUpdate = new CampaignUpdateDto
            {
                CampaignName = Campaign.CampaignName,
                CampaignDescription = string.IsNullOrWhiteSpace(Campaign.CampaignDescription) ? null : Campaign.CampaignDescription
            };

            await DocumentsApi.UpdateCampaign(campaignToUpdate, CampaignId);

            NavigationManager.NavigateTo($"/");
        }
    }

}
