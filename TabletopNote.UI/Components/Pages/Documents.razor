@page "/campaigns/{campaignId:int}/documents"

@using TabletopNote.Shared
@using TabletopNote.UI.Clients
@using TabletopNote.UI.Mappings
@using TabletopNote.UI.ViewModels
@using MudBlazor
@inject DocumentsApiClient DocumentsApi
@inject NavigationManager NavigationManager

<PageTitle>Documents</PageTitle>

<MudStack Spacing="4">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
        <MudText Typo="Typo.h4" Color="Color.Primary">
            Documents
        </MudText>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Warning"
                   StartIcon="@Icons.Material.Outlined.ArrowBack"
                   OnClick="NavigateBack">
            Campaign Info
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="AddDocument">
            New Document
        </MudButton>
    </MudStack>

    @if (State.Page is null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudGrid Spacing="2">
            @foreach (var document in State.Page.CampaignDocuments)
            {
                <MudItem xs="12" sm="6" md="4" lg="4" xl="4">
                    <MudPaper Elevation="3"
                              Outlined="true"
                              Class="pa-4 mx-auto"
                              @key="document.DocumentId"
                              Style="height:100%; max-width:420px; background-color:#1E1E1E; border-color:rgb(126, 87, 194); border-radius:12px;">

                        <MudStack Spacing="2" Style="height:100%;">
                            <MudText Typo="Typo.h6" Color="Color.Primary">
                                @document.DocumentName
                            </MudText>

                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @document.DocumentDescription
                            </MudText>

                            <MudStack Direction="Row" AlignItems="AlignItems.Start" Spacing="1">
                                <MudIcon Icon="@GetContentTypeIcon(document.DocumentContentType.ToString())"
                                         Color="Color.Info"
                                         Size="Size.Small" />
                                <MudText Typo="Typo.caption" Color="Color.Info">
                                    @document.DocumentContentType
                                </MudText>
                            </MudStack>

                            <MudSpacer />

                            <MudStack Direction="Row" Width="100%">
                                <MudButton FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Edit"
                                           Color="Color.Info"
                                           Variant="Variant.Text"
                                           OnClick="() => UpdateSelectedDocument(document.DocumentId)">
                                    Edit
                                </MudButton>

                                <MudDivider Vertical="true" FlexItem="true" />

                                <MudButton FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Variant="Variant.Text"
                                           OnClick="() => DeleteCampaignDocument(CampaignId, document.DocumentId)">
                                    Delete
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
</MudStack>

@code {
    [Parameter]
    public int CampaignId { get; set; }

    private readonly DocumentPageState State = new();

    protected override async Task OnInitializedAsync()
    {
        var dto = await DocumentsApi.GetAllCampaignDocuments(CampaignId);

        State.Page = new DocumentsByCampaignVM
        {
            CampaignId = dto.CampaignId,
            CampaignName = dto.CampaignName,
            CampaignDocuments = dto.CampaignDocuments.Select(cd => cd.ToViewModel()).ToList()
        };
    }

    private void AddDocument()
    {
        NavigationManager.NavigateTo($"campaigns/{CampaignId}/documents/new");
    }

    private void UpdateSelectedDocument(int documentId)
    {
        NavigationManager.NavigateTo($"campaigns/{CampaignId}/documents/{documentId}");
    }

    private string GetContentTypeIcon(string contentType)
    {
        return contentType?.ToLower() switch
        {
            "note" => Icons.Material.Filled.Description,
            "table" => Icons.Material.Filled.TableChart,
            _ => Icons.Material.Filled.EventNote
        };
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo($"/campaigns/{CampaignId}");
    }

    async Task DeleteCampaignDocument(int campaignId, int documentId)
    {
        await DocumentsApi.DeleteCampaignDocument(campaignId, documentId);

        var documentToRemove = State.Page?.CampaignDocuments
            .FirstOrDefault(d => d.DocumentId == documentId && d.CampaignId == campaignId);

        if (documentToRemove != null)
        {
            State.Page?.CampaignDocuments.Remove(documentToRemove);
        }

        StateHasChanged();
    }

}
