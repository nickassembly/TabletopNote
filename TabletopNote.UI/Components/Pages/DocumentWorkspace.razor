@page "/campaigns/{CampaignId:int}/documents/{DocumentId:int}"
@page "/campaigns/{CampaignId:int}/documents/new"

@using TabletopNote.Core.Models
@using TabletopNote.Shared.Dto
@using TabletopNote.UI.Clients
@using TabletopNote.UI.ViewModels
@inject DocumentsApiClient DocumentsApi
@inject NavigationManager NavigationManager
@inject UserTimeService UserTimeService

<PageTitle>Document</PageTitle>

@if (!IsNewDocument)
{
    <MudDrawer Open="true" Elevation="1" Width="260px" ClipMode="DrawerClipMode.Never">
        <MudNavMenu Dense="true" Class="pa-2">
            <CampaignSectionNav CampaignId="@CampaignId" IsHorizontal="false" ButtonSize="Size.Medium" IconSize="Size.Medium" />
        </MudNavMenu>
    </MudDrawer>
}

<MudMainContent Class="pa-6">
    <MudPaper Elevation="4" Class="pa-6 mx-auto"
              Style="max-width:900px; border-radius:12px; background-color:#1E1E1E;">

        <MudStack Spacing="3">
            <MudText Typo="Typo.h4" Color="Color.Primary">
                @(IsNewDocument ? "New Document" : Document.DocumentName)
            </MudText>

            <MudForm @ref="_form" Model="Document" @bind-IsValid="_isFormValid">
                <MudToggleGroup T="DocumentContentType"
                                @bind-Value="Document.DocumentContentType"
                                Color="Color.Primary"
                                Mandatory="true">
                    <MudToggleItem Value="DocumentContentType.Note">
                        <MudIcon Icon="@Icons.Material.Filled.Description" Class="me-1" />
                        Note
                    </MudToggleItem>

                    <MudToggleItem Value="DocumentContentType.Table">
                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Class="me-1" />
                        Table
                    </MudToggleItem>
                </MudToggleGroup>

                <MudDivider Class="my-4" />

                <MudTextField @bind-Value="Document.DocumentName"
                              Label="Title"
                              For="@(() => Document.DocumentName)"
                              Immediate="true"
                              Required="true"
                              MaxLength="100"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="Document.DocumentDescription"
                              Label="Summary"
                              For="@(() => Document.DocumentDescription)"
                              Immediate="true"
                              Required="false"
                              MaxLength="2000"
                              Lines="3"
                              Variant="Variant.Outlined" />

                @if (Document.DocumentContentType == DocumentContentType.Table)
                {
                    <MudText Typo="Typo.h6" Color="Color.Primary">
                        Table functionality to be implemented in future version
                    </MudText>
                }

                @if (Document.DocumentContentType == DocumentContentType.Note)
                {
                    <MudTextField @bind-Value="Document.DocumentContent"
                                  Label="Content"
                                  Lines="30"
                                  Variant="Variant.Outlined" />
                }

                @if (!IsNewDocument)
                {
                    <MudText>
                        Last Update: @userLocalUpdatedAt?.ToString("g")
                    </MudText>

                    <MudText>
                        Created at: @userLocalCreatedAt?.ToString("g")
                    </MudText>
                }

                <MudStack Direction="Row" JustifyContent="SpaceBetween" Class="mt-4">
                    <MudButton Variant="Variant.Text"
                               Color="Color.Secondary"
                               OnClick="Cancel">
                        Cancel
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Disabled="!_isFormValid"
                               Color="Color.Primary"
                               OnClick="SaveCampaignDocument">
                        Save
                    </MudButton>
                </MudStack>
            </MudForm>
        </MudStack>
    </MudPaper>
</MudMainContent>

@code {
    private MudForm _form = null!;
    private bool _isFormValid;

    private DateTime? userLocalCreatedAt;
    private DateTime? userLocalUpdatedAt;

    [Parameter] public int DocumentId { get; set; }
    [Parameter] public int CampaignId { get; set; }

    private bool IsNewDocument => DocumentId == 0;
    private DocumentVM Document { get; set; } = new();
    protected override async Task OnInitializedAsync()
    {
        if (IsNewDocument)
        {
            Document = new DocumentVM
            {
                CampaignId = CampaignId,
                DocumentName = string.Empty,
                DocumentContentType = 0,
                DocumentContent = string.Empty
            };
        }
        else
        {
            var dto = await DocumentsApi.GetCampaignDocumentById(CampaignId, DocumentId);

            Document = new DocumentVM
            {
                DocumentId = dto.DocumentId,
                CampaignId = dto.CampaignId,
                DocumentName = dto.DocumentName,
                DocumentDescription = string.IsNullOrWhiteSpace(dto.DocumentDescription) ? null : dto.DocumentDescription,
                DocumentContentType = dto.DocumentContentType,
                DocumentContent = dto.DocumentContent,
                IsGMVisibleOnly = dto.IsGMVisibleOnly,
                DocumentCreatedAt = dto.DocumentCreatedAt,
                DocumentUpdatedAt = dto.DocumentUpdatedAt
            };
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var tz = await UserTimeService.GetUserTimeZoneAsync();
            userLocalCreatedAt = UserTimeService.ConvertUtcToUserTime(Document.DocumentCreatedAt, tz);
            userLocalUpdatedAt = UserTimeService.ConvertUtcToUserTime(Document.DocumentUpdatedAt, tz);
            StateHasChanged();
        }
    }

    private async Task SaveCampaignDocument()
    {
        await _form.Validate();

        if (!_form.IsValid)
            return;

        if (IsNewDocument)
        {
            var campaignDocumentToAdd = new CampaignDocumentAddDto
            {
                CampaignId = Document.CampaignId,
                DocumentName = Document.DocumentName,
                DocumentDescription = string.IsNullOrWhiteSpace(Document.DocumentDescription) ? null : Document.DocumentDescription,
                DocumentContentType = Document.DocumentContentType,
                DocumentContent = Document.DocumentContent
            };

            await DocumentsApi.AddCampaignDocument(CampaignId, campaignDocumentToAdd);
        }
        else
        {
            var campaignDocumentToUpdate = new CampaignDocumentUpdateDto
            {
                DocumentName = Document.DocumentName,
                DocumentDescription = string.IsNullOrWhiteSpace(Document.DocumentDescription) ? null : Document.DocumentDescription,
                DocumentContentType = Document.DocumentContentType,
                DocumentContent = Document.DocumentContent
            };

            await DocumentsApi.UpdateCampaignDocument(CampaignId, DocumentId, campaignDocumentToUpdate);
        }

        NavigationManager.NavigateTo($"/campaigns/{Document.CampaignId}/documents");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo($"/campaigns/{Document.CampaignId}/documents");
    }
}
